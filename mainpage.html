<!DOCTYPE html>
<html>
	<head>
	</head>
	<body>
	<div id="searchBar">
	<input type="text" id="searchText" value="address or name"></input>
	<button type="button" onclick="search()" value="search button">Search</button>
</form> 
</div>
<div id="mainDiv" style="position:relative;" ></div>
<div id="navigationDiv"></div>
<!-- Utility Functions -->
<script type="text/javascript">
function getTarget(event){
	var target;
	if (!event) var event = window.event;
	if (event.target) target = event.target;
	else if (event.srcElement) target = event.srcElement;
	if (target.nodeType == 3) // defeat Safari bug
		target = target.parentNode;
	return target;
}
function getParams(){
	var qs = window.location.search.substring(1);
	var keyValuePairs = qs.split("&");
	var params = {};
	for( i = 0; i < keyValuePairs.length; i++){
		var temp = keyValuePairs[i].split("=");
		params[decodeURIComponent(temp[0])] = decodeURIComponent(temp[1]);
	}
	return params;
}
function findLocation(eventHandler){
	var args = arguments;
	if (navigator.geolocation){
		navigator.geolocation.getCurrentPosition(
			function(position){
				eventHandler(position, args);
			});
		return true;
	}
	else{
		return false;
	}
}
function getFacebook(requestURL, responseHandler){
	var args = arguments;
	requestURL = encodeURI(requestURL);
	var request = new XMLHttpRequest();
	request.onreadystatechange=function(){
		if(request.readyState==4 & request.status==200){
			if(responseHandler != "none"){
				var response = JSON.parse(request.responseText);
				responseHandler(response, args);
			}
		}
	}
	request.open("GET", requestURL, true);
	request.send();
}
function postFacebook(requestURL, requestData, responseHandler){
	var args = arguments;
	requestURL = encodeURI(requestURL);
	var request = new XMLHttpRequest();
	request.onreadystatechange=function(){
		if(request.readyState==4 & request.status==200){
			if(responseHandler != "none"){
				var response = JSON.parse(request.responseText);
				responseHandler(response, args);
			}
		}
	}
	request.open("POST", requestURL, true);
	request.send(requestData);
}
function getValueFromJson(jObject, accessString){
	if (accessString == "blank") return "";
	var accessors = accessString.split( "." );
	var retval = jObject;
	for (var i = 0 ; i < accessors.length; i++){
		retval = retval[accessors[i]];
	}
	return retval;
}
function getStringFromJson(jObject, accessString){
	var accessors = accessString.split("+");
	var retval = "";
	for (var i = 0; i < accessors.length; i++){
		var start = 0;
		if((start = accessors[i].indexOf("'")) == -1){
			retval += getValueFromJson(jObject, accessors[i]);
		}
		else
		{
			var end = accessors[i].lastIndexOf("'");
			retval += accessors[i].substring(start + 1, end);
		}
	}
	return retval;
}
function checkIn(event){
	var target = getTarget(event);
	findLocation(sendCheckIn, target.value);
}
function sendCheckIn(position, args){
	var url = 'https://graph.facebook.com/me/checkins?access_token=' + accessToken;
	url = encodeURI(url);
	var coords = '{ "latitude": ' + position.coords.latitude + ', "longitude": ' + position.coords.longitude + '}';
	var data = 'place=' + args[1] + '&coordinates=' + coords; 
	postFacebook(url, data, "none");	
}
function search(){
	var searchURL = 'https://graph.facebook.com/search?q=' +
	document.getElementById("searchText").value + '&' +
	'type=place&' + 
	'access_token=' + accessToken;
	getFacebook(searchURL, loadPlaces);	
}
</script>
<!-- List View Functions -->
<script type="text/javascript">
function generateTable(data, dataMap){
	var listhtml = '';
	for (i = 0; i < data.length; i++){
		listhtml += '<div style="height:50px;padding:10px" id="placeRow' + i + '" onclick="handleListClick(event)" title=' + data[i].id + '>' + data[i].name + '</div>';
	}
	document.getElementById("mainDiv").innerHTML=listhtml;
	for (i = 0; i < data.length; i++){
		generateRow(data[i], dataMap, i);
	}
}
function generateRow(data, dataMap, rowIndex){
	var row = document.getElementById('placeRow' + rowIndex);
	var rowhtml = "";
	rowhtml += '<img src="https://graph.facebook.com/' + getValueFromJson(data, dataMap["id"]) + '/picture?type=square"/>';
	rowhtml += '<h1 style="font-size:20px;position:relative;right:-70px;top:-70px;">' + getValueFromJson(data,dataMap["title"]) + '</h1>';
	rowhtml += '<p style="font-size:15px;position:relative;right:-70px;top:-75px;">' + getValueFromJson(data,dataMap["details"]) + '</p>';
	row.innerHTML = rowhtml;
}
function generatePaging(pageLinks){
	if(pageLinks){
		var next = pageLinks.next;
		var prev = pageLinks.previous;
		var paginghtml = "";
		if(prev){
			prev += 'access_token=' + accessToken;
			paginghtml += '<button type="button" onclick="loadNewPlaces(event)" value="' + prev + '">Previous</button>';
		}
		if(next){
			next += 'access_token=' + accessToken;
			paginghtml += '<button type="button" onclick="loadNewPlaces(event)" value="' + next + '">Next</button>';
		}
	document.getElementById("navigationDiv").innerHTML = paginghtml;
	}
}
function loadPlaces(places){
	var dataMap = new Array();
	dataMap["id"] = "id";
	dataMap["title"] = "name";
	dataMap["details"] = "location.street";
	generateTable(places.data, dataMap);
	generatePaging(places.paging);
}
function loadPeople(people){
	var dataMap = new Array();
	dataMap["id"] = "id";
	dataMap["title"] = "name";
	dataMap["details"] = "blank";
	generateTable(people.data, dataMap);
	generatePaging(people.paging);
}
function handleListClick(event){
	var target = getTarget(event);
	var dataMap = new Array();
	dataMap["id"] = "id";
	dataMap["name"] = "name";
	dataMap["hLine1"] = "location.street";
	dataMap["hLine2"] = "location.city+', '+location.state+', '+location.country";
	dataMap["details"] = "description";
	getPageInfo(target.title, dataMap);
}
</script>
<!-- Page View Functions -->
<script type="text/javascript">
function getPageInfo(id, dataMap){
	var requestURL = 'https://graph.facebook.com/' + id;
	requestURL = encodeURI(requestURL);
	getFacebook(requestURL, createPageView, dataMap);
}
function createPageView(data, args){
	var dataMap = args[2];
	generatePageView(data, dataMap);
	createNavigationButtons(data);
}
function generatePageView(data, dataMap){
	var mainhtml = '<div id="basicInfo" style="position:static;" >';
	mainhtml += '<img style="position:static;" src="https://graph.facebook.com/' + getValueFromJson(data, dataMap["id"]) + '/picture?type=normal"/>';
	mainhtml += '<h1 style="font-size:20px;position:absolute;left:120px;top:0px">' + getValueFromJson(data, dataMap["name"]) + '</h1>';
	var addresshtml = '';
	mainhtml += '<p style="font-size:15px;position:absolute;left:120px;top:30px;">' + getStringFromJson(data, dataMap["hLine1"]) + '</p>';
	mainhtml += '<p style="font-size:15px;position:absolute;left:120px;top:50px;">' 
	mainhtml += '<p style="font-size:15px;position:absolute;left:120px;top:50px;">' + getStringFromJson(data, dataMap["hLine2"]) + '</p></div>'
	mainhtml += '<div id="details" style="position:static;" >';
	mainhtml += '<p style="font-size:18px;">' + getStringFromJson(data, dataMap["details"]) + '</p>';
	mainhtml += '</div>';
	listhtml = document.getElementById("mainDiv").innerHTML;
	document.getElementById("mainDiv").innerHTML = mainhtml;
}
function createNavigationButtons(place){
	var navigationhtml = "";
	navigationhtml += '<button type="button" onclick="backToList()">Back</button>';
	navigationhtml += '<button type="button" onclick="checkIn(event)" value="' + place.id + '">Check In</button>';
	paginghtml = document.getElementById("navigationDiv").innerHTML;
	document.getElementById("navigationDiv").innerHTML = navigationhtml;
}
var listhtml;
var paginghtml;
function backToList(){
	document.getElementById("mainDiv").innerHTML = listhtml;
	document.getElementById("navigationDiv").innerHTML = paginghtml;
}
</script>
<!-- Places Functions -->
<script type="text/javascript">
function getPlaces(position){
	var dist;
	if (position.coords.accuracy > 1000) dist = position.coords.accuracy;
	else dist = 1000;
	document.getElementById("mainDiv").innerHTML='Loading';
	var requestURL = 'https://graph.facebook.com/search?' +
	'type=place&' + 
	'center=' + position.coords.latitude + ',' + position.coords.longitude + '&' +
	'distance=' + dist + '&' +
	'limit=25&' + 
	'format=json&' +
	'access_token=' + accessToken;
	getFacebook(requestURL, loadPlaces);
}
function loadNewPlaces(event){
	var target = getTarget(event);
	getFacebook(target.value, loadPlaces);
}
</script>
<script type="text/javascript">
var params = getParams();
var accessToken = params["access_token"];
findLocation(getPlaces);	
</script>
</body>
</html>